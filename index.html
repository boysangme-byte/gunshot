<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<title>악령사냥 v12.0</title>
<style>
  body{margin:0;background:#0a0015;color:#fff;font-family:Arial, sans-serif;overflow:hidden}
  canvas{display:block;margin:0 auto;background:#000}
  #hud{position:absolute;bottom:0;left:0;right:0;display:flex;justify-content:space-around;
    background:#1a0b2f;color:#e9d7ff;font-size:14px;padding:4px 0;border-top:1px solid #4a2977}
  #helpBar{position:absolute;bottom:32px;left:0;right:0;text-align:center;font-size:13px;
    background:#1a0b2f;color:#e9d7ff;padding:6px 12px;border-top:1px solid #4a2977}
  #dashCooldown{position:absolute;bottom:64px;left:50%;transform:translateX(-50%);width:300px;
    height:10px;background:#331;border:1px solid #555}
  #dashBar{height:100%;background:#9f5fff;width:100%}
  #overlay{position:absolute;inset:0;background:#000c;color:#fff;display:none;align-items:center;justify-content:center;flex-direction:column}
  #overlay button{margin-top:20px;padding:10px 20px}
  .damageFlash{position:absolute;inset:0;background:rgba(255,0,0,0.4);display:none;z-index:10}
</style>
</head>
<body>
<div id="gameContainer" style="position:relative;width:100vw;height:100vh">
  <canvas id="gameCanvas" width="960" height="600"></canvas>
  <div id="hud">
    <div>점수: <span id="score">0</span></div>
    <div>무기: <span id="weapon">Pistol</span></div>
    <div>체력: <span id="health">7</span></div>
    <div>보스: <span id="boss">-</span></div>
    <div>난이도: <span id="difficulty">1.0x</span></div>
  </div>
  <div id="helpBar">
    WASD 이동 · 마우스 발사 · 무기 1/2/3 전환 · Shift 대쉬 ｜ Heal=+1 ｜ Zoey=보호막(3중첩) ｜ Mira=폭발+가속 ｜ 보스=500점마다 ｜ Mystery=범위공격
  </div>
  <div id="dashCooldown"><div id="dashBar"></div></div>
  <div id="overlay">
    <h1>게임 오버</h1>
    <p>최종 점수: <span id="finalScore">0</span></p>
    <button onclick="restart()">다시 시작</button>
  </div>
  <div id="damageFlash" class="damageFlash"></div>
</div>
<script>
const canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");
let keys={},mouse={x:480,y:300,down:false};
document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);
canvas.addEventListener("mousemove",e=>{let r=canvas.getBoundingClientRect();mouse.x=e.clientX-r.left;mouse.y=e.clientY-r.top});
canvas.addEventListener("mousedown",()=>mouse.down=true);
canvas.addEventListener("mouseup",()=>mouse.down=false);

let player={x:480,y:300,hp:7,speed:220,fireCd:0,invuln:0,zoey:[]};
let score=0,difficulty=1,gameOver=false,lasers=[],bullets=[],enemies=[],items=[],boss=null;
let dashCd=0,dashActive=0;
let maxEnemies=60;

function spawnEnemy(){
  if(enemies.length>=maxEnemies)return;
  let x=Math.random()<.5?(Math.random()*canvas.width): (Math.random()<.5?-20:canvas.width+20);
  let y=Math.random()<.5?(Math.random()*canvas.height): (Math.random()<.5?-20:canvas.height+20);
  enemies.push({x,y,hp:3,type:"normal",r:20});
}
function spawnBoss(){ boss={x:canvas.width/2,y:100,hp:160*difficulty,phase:1,cd:0}; }
function fire(){
  if(player.fireCd>0)return;
  if(currentWeapon==="pistol"){
    bullets.push({x:player.x,y:player.y,vx:(mouse.x-player.x),vy:(mouse.y-player.y),spd:500,r:4,dmg:1});
    player.fireCd=0.2;
  }else if(currentWeapon==="shotgun"){
    for(let i=0;i<7;i++){
      let a=Math.atan2(mouse.y-player.y,mouse.x-player.x)+(Math.random()-0.5)*0.3;
      bullets.push({x:player.x,y:player.y,vx:Math.cos(a),vy:Math.sin(a),spd:520,r:4,dmg:1,range:260});
    }
    player.fireCd=0.3;
  }else if(currentWeapon==="laser"){
    let a=Math.atan2(mouse.y-player.y,mouse.x-player.x);
    lasers.push({x:player.x,y:player.y,a,t:0});
    player.fireCd=0.45;
  }
}
let currentWeapon="pistol";

function update(dt){
  if(gameOver)return;
  if(player.invuln>0)player.invuln-=dt;
  if(dashCd>0)dashCd-=dt;
  if(dashActive>0){dashActive-=dt;}
  if(keys["1"])currentWeapon="pistol";
  if(keys["2"])currentWeapon="shotgun";
  if(keys["3"])currentWeapon="laser";
  if(mouse.down)fire();
  if(player.fireCd>0)player.fireCd-=dt;

  let dx=(keys["d"]?1:0)-(keys["a"]?1:0);
  let dy=(keys["s"]?1:0)-(keys["w"]?1:0);
  let len=Math.hypot(dx,dy)||1;
  let sp=player.speed*(dashActive>0?2.5:1);
  player.x+=dx/len*sp*dt; player.y+=dy/len*sp*dt;
  player.x=Math.max(0,Math.min(canvas.width,player.x));
  player.y=Math.max(0,Math.min(canvas.height,player.y));

  // 적 스폰
  if(Math.random()<0.015+(difficulty-1)*0.018)spawnEnemy();
  // 보스 스폰
  if(score>=500 && !boss)spawnBoss();

  // 총알
  bullets.forEach(b=>{
    if(b.range){ b.range-=dt*500; if(b.range<=0)b.dead=true; }
    b.x+=b.vx*(b.spd?dt:1); b.y+=b.vy*(b.spd?dt:1);
    if(b.spd){b.x+=b.vx*dt; b.y+=b.vy*dt;}
    enemies.forEach(e=>{
      if(!e.dead&&Math.hypot(b.x-e.x,b.y-e.y)<e.r+b.r){
        e.hp-=b.dmg;flashEnemy(e);
        if(e.hp<=0){e.dead=true;score+=10;}
        b.dead=true;
      }
    });
    if(boss && Math.hypot(b.x-boss.x,b.y-boss.y)<boss.r+5){ boss.hp-=b.dmg; flashBoss(); b.dead=true; if(boss.hp<=0){score+=100;boss=null;difficulty*=1.3;} }
  });
  bullets=bullets.filter(b=>!b.dead);

  // 레이저
  lasers.forEach(l=>{
    l.t+=dt;
    if(l.t>0.2)l.dead=true;
    let ex=l.x+Math.cos(l.a)*1600,ey=l.y+Math.sin(l.a)*1600;
    enemies.forEach(e=>{
      if(!e.dead && lineCircle(l.x,l.y,ex,ey,e.x,e.y,e.r)){ e.hp-=2;flashEnemy(e); if(e.hp<=0){e.dead=true;score+=10;} }
    });
    if(boss && lineCircle(l.x,l.y,ex,ey,boss.x,boss.y,boss.r)){ boss.hp-=2;flashBoss(); if(boss.hp<=0){score+=100;boss=null;difficulty*=1.3;} }
  });
  lasers=lasers.filter(l=>!l.dead);

  enemies=enemies.filter(e=>!e.dead);

  // HUD
  document.getElementById("score").textContent=score;
  document.getElementById("weapon").textContent=currentWeapon;
  document.getElementById("health").textContent=player.hp;
  document.getElementById("boss").textContent=boss?"Alive":"-";
  document.getElementById("difficulty").textContent=difficulty.toFixed(2)+"x";

  // 보스 패턴
  if(boss){
    boss.cd-=dt;
    if(boss.hp<80*difficulty && boss.phase===1){boss.phase=2;}
    if(boss.cd<=0){
      boss.cd=1;
      if(boss.phase===2){
        let tx=Math.random()*canvas.width,ty=Math.random()*canvas.height;
        boss.x+=(tx-boss.x)*0.3;boss.y+=(ty-boss.y)*0.3;
        if(Math.hypot(player.x-boss.x,player.y-boss.y)<boss.r+20)damagePlayer(2);
      }
    }
  }
}
function damagePlayer(n){
  if(player.invuln>0)return;
  if(player.zoey.length>0){player.zoey.pop();return;}
  player.hp-=n;
  if(player.hp<=0){gameOver=true;document.getElementById("overlay").style.display="flex";document.getElementById("finalScore").textContent=score;}
  player.invuln=2;
  document.getElementById("damageFlash").style.display="block";
  setTimeout(()=>document.getElementById("damageFlash").style.display="none",200);
}
function flashEnemy(e){ctx.save();ctx.globalAlpha=0.5;ctx.fillStyle="white";ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();ctx.restore();}
function flashBoss(){/*비슷하게 boss 피드백*/}
function lineCircle(x1,y1,x2,y2,cx,cy,cr){const dx=x2-x1,dy=y2-y1,l2=dx*dx+dy*dy;let t=((cx-x1)*dx+(cy-y1)*dy)/l2;t=Math.max(0,Math.min(1,t));const px=x1+t*dx,py=y1+t*dy;return Math.hypot(px-cx,py-cy)<=cr;}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="cyan";
  ctx.beginPath();
  ctx.arc(player.x,player.y,20,0,Math.PI*2);
  ctx.fill();
  enemies.forEach(e=>{ctx.fillStyle="purple";ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();});
  if(boss){ctx.fillStyle="red";ctx.beginPath();ctx.arc(boss.x,boss.y,40,0,Math.PI*2);ctx.fill();}
  bullets.forEach(b=>{ctx.fillStyle="yellow";ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();});
  lasers.forEach(l=>{ctx.strokeStyle="lime";ctx.beginPath();ctx.moveTo(l.x,l.y);ctx.lineTo(l.x+Math.cos(l.a)*1600,l.y+Math.sin(l.a)*1600);ctx.stroke();});
  // Zoey 보호막 표시
  player.zoey.forEach((z,i)=>{
    let angle=performance.now()/500+i*2*Math.PI/player.zoey.length;
    ctx.strokeStyle="aqua";
    ctx.beginPath();
    ctx.arc(player.x+Math.cos(angle)*30,player.y+Math.sin(angle)*30,10,0,Math.PI*2);
    ctx.stroke();
  });
}
function loop(t){update(1/60);draw();requestAnimationFrame(loop);}
requestAnimationFrame(loop);
function restart(){location.reload();}
</script>
</body>
</html>
